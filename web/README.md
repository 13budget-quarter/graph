# CPG Explorer

Interactive Code Property Graph visualization for Go codebases. A single-binary web application that explores a pre-generated SQLite CPG database (~900 MB, ~555K nodes, ~1.5M edges) produced by `cpg-gen`.

## Quick Start

```bash
docker compose up
```

Open [http://localhost:8080](http://localhost:8080). Requires `cpg.db` in the project root.

## Generating the Database

The CPG database is generated by `cpg-gen` from the root of the repository. Four Prometheus modules are included:

```bash
git submodule update --init
go build -o cpg-gen .
./cpg-gen -verbose ./prometheus cpg.db \
  -modules "./client_golang:github.com/prometheus/client_golang:client_golang,./prometheus-adapter:sigs.k8s.io/prometheus-adapter:adapter,./alertmanager:github.com/prometheus/alertmanager:alertmanager"
```

The 4th module (**alertmanager**) was chosen because it is a core Prometheus component with rich call graph structure (notification pipelines, inhibition rules, silencing logic) that adds meaningful cross-module call edges to the CPG.

## Features

### 1. Package Architecture Map (`/packages`)
- Interactive package dependency graph rendered with Sigma.js (WebGL)
- Package list sorted by cyclomatic complexity with module color-coding
- Click a package node to drill down into its functions
- Metrics: LOC, function count, type count, complexity per package

### 2. Call Graph Explorer (`/callgraph`)
- **Neighborhood mode**: 1-hop callers + callees of any function
- **Call chain mode**: BFS traversal up to configurable depth (1–10)
- Source code viewer with line highlighting (highlight.js)
- Function detail panel with complexity, fan-in/out, callers/callees

### 3. Data Flow Slicer (`/dataflow`)
- **Forward slice**: trace how a variable's value flows through the program
- **Backward slice**: trace where a variable's value comes from
- Source code overlay highlighting all affected lines in the current file
- Package/function picker for selecting start nodes

### Cross-cutting
- **Symbol search** with debounced autocomplete across all packages
- Deep-linking: URL parameters (`?id=`, `?pkg=`) for bookmarking
- Dark theme with CSS variables

## Architecture

```
┌─────────────────────────────────────────────┐
│              Browser (SPA)                  │
│  SvelteKit + Sigma.js + highlight.js        │
│  ┌──────────┐ ┌──────────┐ ┌────────────┐  │
│  │ Packages │ │CallGraph │ │ Data Flow  │  │
│  └──────────┘ └──────────┘ └────────────┘  │
└───────────────────┬─────────────────────────┘
                    │ fetch /api/*
┌───────────────────┴─────────────────────────┐
│           Go HTTP Server                     │
│     net/http 1.22+ (method patterns)        │
│     embed.FS (serves SPA)                   │
│     10 JSON API endpoints                   │
└───────────────────┬─────────────────────────┘
                    │ database/sql
┌───────────────────┴─────────────────────────┐
│        SQLite (read-only)                    │
│     modernc.org/sqlite (pure Go)            │
│     WAL mode, mmap 256MB, 64K cache pages   │
└─────────────────────────────────────────────┘
```

Single binary with embedded frontend (`embed.FS`). No reverse proxy needed.

## API Endpoints

| Endpoint | Description |
|---|---|
| `GET /api/packages` | List all packages with LOC, complexity, function count |
| `GET /api/packages/graph` | Package dependency graph (nodes + edges) |
| `GET /api/functions?package=PKG` | Functions in a package |
| `GET /api/function/{id}` | Full function detail (metrics, callers, callees) |
| `GET /api/graph/neighborhood/{id}` | 1-hop call graph neighborhood |
| `GET /api/graph/call-chain/{id}?depth=N` | BFS call chain (default depth=3, max=10) |
| `GET /api/graph/forward-slice/{id}` | Forward data-flow slice (recursive CTE) |
| `GET /api/graph/backward-slice/{id}` | Backward data-flow slice (recursive CTE) |
| `GET /api/source?file=PATH` | Source file content |
| `GET /api/search?q=PATTERN` | Symbol search (LIKE-based, limit 50) |

## Tech Stack

| Layer | Technology | Why |
|---|---|---|
| Backend | Go stdlib `net/http` | Zero dependencies for HTTP; 1.22+ method patterns eliminate router libraries |
| Database | `modernc.org/sqlite` | Pure Go SQLite (no CGo), cross-compiles, `database/sql` interface |
| Frontend | SvelteKit (adapter-static) | Compiler-based framework with minimal runtime; SPA mode for `embed.FS` |
| Graphs | Sigma.js + graphology | WebGL rendering for large graphs (100K+ nodes); ForceAtlas2 layout |
| Syntax | highlight.js | Tree-shakeable, Go language support, dark theme |
| CSS | Native CSS variables | No CSS framework overhead; scoped styles via Svelte |

**Total: 5 runtime dependencies** (modernc/sqlite, sigma, graphology, forceatlas2, highlight.js).

## Development

### Prerequisites
- Go 1.25+
- Node.js 22+
- A `cpg.db` file generated by `cpg-gen`

### Backend
```bash
cd web
go test -race -count=1 ./...    # 45 tests
go build -o cpg-explorer .
./cpg-explorer -db ../cpg.db
```

### Frontend
```bash
cd web/frontend
npm install
npm run dev                     # dev server with hot reload (proxies /api → :8080)
npm run build                   # production build → build/
```

### Full stack (dev mode)
```bash
# Terminal 1: Go backend
cd web && go run . -db ../cpg.db

# Terminal 2: SvelteKit dev server
cd web/frontend && npm run dev
```

### Docker
```bash
docker compose up --build
```

## Design Decisions

1. **Single binary over microservices**: `embed.FS` bundles the SPA into the Go binary. One container, one process, zero orchestration.

2. **Read-only SQLite over a query engine**: The CPG database is pre-computed. Read-only mode + WAL + mmap gives excellent query performance without write overhead.

3. **Recursive CTEs for graph traversal**: Call chains and data-flow slices use `WITH RECURSIVE` queries in SQLite, keeping graph logic in SQL rather than Go code.

4. **Sigma.js (WebGL) over D3 (SVG)**: The CPG has 555K nodes. SVG-based renderers struggle above ~5K nodes. Sigma.js with WebGL handles 100K+ nodes at 60fps.

5. **SvelteKit SPA over SSR**: With `adapter-static` and `ssr: false`, the entire frontend compiles to static files. No Node.js runtime needed at deploy time.

6. **Native CSS over Tailwind/CSS-in-JS**: CSS variables for theming, Svelte scoped styles for components. Zero tooling overhead, small bundle size.

7. **No ORM**: Direct parameterized SQL queries. The schema is stable and read-only — an ORM would add complexity without benefit.

## Testing

- **45 Go tests** covering all query functions and HTTP handlers
- Race detector enabled (`-race` flag)
- Test fixture: in-memory SQLite with representative data (3 packages, 7 functions, call/DFG edges, source code)
- Each test function creates its own database — no shared state

## Project Structure

```
web/
├── main.go              # Entry point, embed.FS, SPA fallback routing
├── handlers.go          # HTTP handlers for 10 API endpoints + CORS
├── queries.go           # SQL query functions (recursive CTEs for graph traversal)
├── models.go            # API response DTOs
├── handlers_test.go     # 20 handler tests
├── queries_test.go      # 25 query tests
├── testdata/fixture.sql # Test fixture SQL
├── Dockerfile           # Multi-stage build (node → go → alpine)
├── .dockerignore
└── frontend/
    ├── src/
    │   ├── app.css             # CSS variables, dark theme, reset
    │   ├── lib/
    │   │   ├── api.ts          # Typed API client (10 endpoints)
    │   │   ├── GraphCanvas.svelte  # Sigma.js + graphology wrapper
    │   │   ├── SourceViewer.svelte # highlight.js with line numbers
    │   │   ├── SearchBar.svelte    # Debounced symbol search
    │   │   └── NodePanel.svelte    # Function detail panel
    │   └── routes/
    │       ├── +layout.svelte      # Nav bar, search, layout grid
    │       ├── +layout.ts          # SPA config (ssr: false)
    │       ├── +page.svelte        # Landing page
    │       ├── packages/+page.svelte   # Package Architecture Map
    │       ├── callgraph/+page.svelte  # Call Graph Explorer
    │       └── dataflow/+page.svelte   # Data Flow Slicer
    ├── svelte.config.js    # adapter-static, SPA fallback
    ├── vite.config.ts      # API proxy for dev mode
    └── package.json
```
